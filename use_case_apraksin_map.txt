================================================================================
                    USE CASE ДОКУМЕНТ: APRAXIN MAP
              Маркетплейс павильонов торговых центров "Апраксин"
================================================================================

НАЗНАЧЕНИЕ СИСТЕМЫ:
Веб-приложение для просмотра интерактивной карты павильонов торговых центров,
поиска товаров и услуг, управления информацией о павильонах и скидках.

================================================================================
                              АКТОРЫ СИСТЕМЫ
================================================================================

АКТОР 1: ПОСЕТИТЕЛЬ
Роль: Неавторизованный пользователь, посещающий торговый центр
Цель: Найти нужны павильон, узнать информацию о товарах и услугах
Права: Просмотр общедоступной информации

АКТОР 2: АРЕНДАТОР
Роль: Владелец или менеджер павильона
Цель: Управлять информацией о своем павильоне, добавлять скидки, обновлять данные
Права: Редактирование информации своего павильона

АКТОР 3: СУПЕР-АДМИН
Роль: Администратор системы
Цель: Управлять всеми павильонами, пользователями, модерировать контент
Права: Полный доступ к системе

================================================================================
                    СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ - ПОСЕТИТЕЛЬ
================================================================================

USE CASE 1: ПРОСМОТР ИНТЕРАКТИВНОЙ КАРТЫ
─────────────────────────────────────────

Предусловия:
- Посетитель открыл приложение Apraxin Map
- Приложение успешно загрузилось
- Доступ в интернет есть

Основной поток событий:
1. Система отображает интерактивную карту торговых центров
2. На карте отмечены все павильоны с цветовыми обозначениями по категориям
3. Посетитель видит легенду с расшифровкой категорий
4. Посетитель может приблизить/отдалить карту (zoom)
5. Посетитель может перемещаться по карте (pan)
6. Система отображает названия павильонов над их обозначениями
7. Посетитель видит информацию о районе (этаж, блок)

Альтернативный поток 1: Проблемы с загрузкой карты
- Если данные не загружаются, система показывает сообщение об ошибке
- Предлагает обновить страницу (refresh)
- Показывает кэшированную версию (если доступна)

Альтернативный поток 2: Автономная работа (режим PWA)
- Если нет интернета, приложение работает в режиме offline
- Показывает кэшированные данные
- Уведомляет пользователя об ограниченной функциональности

Постусловия:
- Карта успешно отображена
- Посетитель может видеть все павильоны
- Интерактивные элементы карты работают


USE CASE 2: ПОИСК ПАВИЛЬОНА ПО НАЗВАНИЮ
────────────────────────────────────────

Предусловия:
- Посетитель находится на странице с картой
- Доступна функция поиска

Основной поток событий:
1. Посетитель кликает на поле поиска
2. Вводит название павильона или ключевые слова (например "Обувь", "Кафе")
3. Система фильтрует павильоны в реальном времени (по мере ввода)
4. На карте остаются только подходящие павильоны, остальные затемняются
5. Посетитель видит список найденных павильонов
6. Посетитель кликает на результат поиска
7. Система выделяет найденный павильон на карте и панирует к нему

Альтернативный поток 1: Поиск не дал результатов
- Система выводит сообщение "Павильон не найден"
- Предлагает уточнить критерии поиска
- Показывает похожие результаты (по ассоциации)

Альтернативный поток 2: Поиск по категориям
- Вместо текстового поиска используются фильтры по категориям
- Система показывает все павильоны выбранной категории

Постусловия:
- Нужный павильон найден и выделен на карте
- Посетитель может кликнуть на павильон для подробной информации


USE CASE 3: ПРОСМОТР ИНФОРМАЦИИ О ПАВИЛЬОНЕ
─────────────────────────────────────────────

Предусловия:
- Посетитель находится на странице карты
- На карте отображаются павильоны
- Посетитель знает название или местоположение павильона

Основной поток событий:
1. Посетитель кликает на павильон на карте (или в списке)
2. Система открывает модальное окно или переходит на страницу павильона
3. Отображается информация о павильоне:
   - Название и описание
   - Адрес (этаж, номер павильона)
   - Категория/тип бизнеса
   - Контактная информация (телефон, Instagram, WhatsApp и т.д.)
   - Логотип/фото павильона
   - Часы работы
4. Система показывает текущие скидки и акции
5. Посетитель может сохранить павильон в избранное (если авторизован) - ВАЖНО: функция "Избранное" улучшает юзабилити и пользовательский опыт
6. Посетитель может поделиться информацией в социальных сетях (Яндекс, ВК, Telegram) с возможностью поделиться изображением, товаром, локацией или павильоном (подготовка к реферальной программе)

Альтернативный поток 1: Павильон закрыт
- Система отображает информацию о статусе "Закрыто"
- Показывает время открытия
- Позволяет оставить сообщение в очереди

Альтернативный поток 2: Специальное предложение/скидка
- Если есть активная скидка, она выделяется цветом
- Можно сгенерировать QR-код для скидки
- Возможно поделиться скидкой с друзьями

Постусловия:
- Полная информация о павильоне доступна
- Посетитель может принять решение о посещении


USE CASE 4: ФИЛЬТРАЦИЯ ПО КАТЕГОРИЯМ
──────────────────────────────────────

Предусловия:
- Посетитель находится на странице карты
- Загружены данные о категориях павильонов

Основной поток событий:
1. Посетитель открывает панель фильтров
2. Система показывает список всех доступных категорий:
   - Одежда и обувь
   - Продукты питания
   - Кафе и рестораны
   - Электроника
   - Красота и здоровье
   - Развлечения и другие
3. Посетитель выбирает одну или несколько категорий (чек-бокс)
4. Система фильтрует павильоны
5. На карте остаются только павильоны выбранных категорий
6. Отображается количество найденных павильонов
7. Посетитель может снять фильтр и вернуться к полному списку

Альтернативный поток 1: Комбинированный фильтр
- Можно одновременно искать по тексту и категориям
- Результаты пересекаются (логическое И)

Постусловия:
- Карта отфильтрована по выбранным категориям
- Остальные павильоны скрыты или затемнены


USE CASE 5: ПРОСМОТР СКИДОК И АКЦИЙ
────────────────────────────────────

Предусловия:
- Посетитель авторизован или может просматривать скидки без авторизации
- На сервере загружены актуальные скидки

Основной поток событий:
1. Посетитель переходит на страницу "Скидки" или "Акции"
2. Система показывает список активных скидок
3. Каждая скидка содержит:
   - Название павильона
   - Описание скидки (размер, условия)
   - Дату начала и окончания
   - Иконку категории
4. Посетитель может отсортировать по:
   - Дате (новые первыми)
   - Размеру скидки (больше первыми)
   - Названию павильона
5. Посетитель кликает на скидку
6. Система показывает полное описание и может предложить QR-код
7. Посетитель может скопировать скидку или поделиться ей

Альтернативный поток 1: Фильтр по категориям
- На странице скидок также работает фильтр по категориям
- Показываются только скидки выбранных павильонов

Постусловия:
- Посетитель видит все доступные скидки
- Может использовать скидку при посещении павильона


================================================================================
                    СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ - АРЕНДАТОР
================================================================================

USE CASE 6: АВТОРИЗАЦИЯ АРЕНДАТОРА
──────────────────────────────────

Предусловия:
- Арендатор открыл приложение
- Он имеет зарегистрированный номер телефона в системе
- У него есть доступ в интернет

Основной поток событий:
1. Арендатор переходит на страницу входа (admin.html)
2. Выбирает страну (по умолчанию +7 для России)
3. Вводит свой номер телефона
4. Нажимает "Отправить код"
5. Система отправляет SMS с кодом подтверждения (ЗАГЛУШКА: функция готова, но реальная отправка СМС требует согласования с администрацией из-за платности услуги)
6. Арендатор вводит полученный код
7. Система проверяет код
8. Если код верный - арендатор авторизуется
9. При первом входе или для владельцев павильонов система запрашивает настройку двухфакторной аутентификации (2FA)
10. Система перенаправляет на страницу личного кабинета
11. Отображаются данные павильона арендатора

ПРИМЕЧАНИЕ: Двухфакторная аутентификация (2FA) обязательна для владельцев павильонов (is_owner = true) и рекомендована для всех арендаторов для повышения безопасности.

Альтернативный поток 1: Неверный номер телефона
- Система показывает ошибку "Номер не найден"
- Предлагает повторить ввод или связаться с поддержкой
- Показывает ссылку на форму регистрации новых арендаторов

Альтернативный поток 2: Неверный код подтверждения
- Система показывает ошибку
- Предлагает отправить код повторно
- Ограничивает количество попыток ввода (защита от брута)

Альтернативный поток 3: Код истек
- Система показывает сообщение "Код истек"
- Предлагает отправить код заново

Постусловия:
- Арендатор авторизован в системе
- Доступна статистика и управление информацией павильона


USE CASE 7: РЕДАКТИРОВАНИЕ ИНФОРМАЦИИ ПАВИЛЬОНА
─────────────────────────────────────────────────

Предусловия:
- Арендатор авторизован
- Находится в личном кабинете
- Павильон уже создан в системе

Основной поток событий:
1. Арендатор видит свой павильон в личном кабинете
2. Клавишей "Редактировать" или "Изменить информацию"
3. Система открывает форму редактирования с полями:
   - Название павильона
   - Описание (текст, максимум 500 символов)
   - Категория (выбор из списка)
   - Контактный телефон
   - Email
   - Социальные сети (Instagram, WhatsApp, Telegram и т.д.)
   - Логотип/фото павильона (загрузка файла)
   - Часы работы (выбор по дням недели)
4. Арендатор редактирует необходимые поля
5. Добавляет или обновляет фото/логотип
6. Нажимает "Сохранить"
7. Система валидирует введенные данные
8. Сохраняет изменения в БД
9. Показывает сообщение об успехе
10. Обновленные данные появляются на карте для всех пользователей

Альтернативный поток 1: Ошибка валидации
- Система показывает ошибку в полях (красное выделение)
- Указывает причину (поле обязательно, неверный формат и т.д.)
- Не позволяет сохранить до исправления

Альтернативный поток 2: Проблема при загрузке фото
- Если файл перегружен или неподдерживаемый формат
- Система показывает ошибку
- Предлагает сжать изображение или выбрать другой формат

Альтернативный поток 3: Черновик (Draft)
- Арендатор может сохранить как черновик
- Вернуться к редактированию позже
- Изменения не публикуются до финального сохранения

Постусловия:
- Информация павильона обновлена
- Изменения сохранены в БД
- Обновленные данные видны всем посетителям


USE CASE 8: УПРАВЛЕНИЕ СКИДКАМИ И АКЦИЯМИ
───────────────────────────────────────────

Предусловия:
- Арендатор авторизован
- Находится в личном кабинете
- Павильон создан и активен

Основной поток событий:
1. Арендатор переходит в раздел "Скидки" или "Промо"
2. Видит список существующих скидок
3. Нажимает "Добавить новую скидку"
4. Система открывает форму создания скидки с полями:
   - Название/описание скидки
   - Размер скидки (% или фиксированная сумма)
   - Условия применения (минимальная покупка и т.д.)
   - Дата и время начала
   - Дата и время окончания
   - Категория товаров (если применимо)
   - Ограничение количества использований (опционально)
5. Арендатор заполняет форму
6. Может добавить изображение/баннер (опционально)
7. Нажимает "Создать"
8. Система валидирует данные (дата окончания > даты начала и т.д.)
9. Сохраняет скидку
10. Скидка НЕМЕДЛЕННО публикуется и становится видна всем посетителям в разделе "Скидки" (без модерации)

Альтернативный поток 1: Редактирование существующей скидки
- Арендатор кликает на скидку из списка
- Система открывает форму редактирования
- Позволяет изменить все параметры
- Сохраняет изменения

Альтернативный поток 2: Удаление скидки
- Арендатор выбирает скидку
- Нажимает "Удалить" или "Снять"
- Система запрашивает подтверждение
- Удаляет скидку из активных
- Скидка больше не видна посетителям

Альтернативный поток 3: Планируемая скидка
- Введена дата начала в будущем
- Система сохраняет скидку как "Планируемая"
- Она не видна посетителям до установленной даты
- Автоматически активируется в нужное время

Постусловия:
- Скидка создана или отредактирована
- Она видна в разделе скидок для посетителей
- Данные синхронизированы со всеми платформами


USE CASE 9: УПРАВЛЕНИЕ КОНТАКТАМИ И СОЦИАЛЬНЫМИ СЕТЯМИ
─────────────────────────────────────────────────────────

Предусловия:
- Арендатор авторизован
- Находится в разделе личного кабинета
- Может редактировать информацию

Основной поток событий:
1. Арендатор переходит в раздел "Контакты" или редактирования информации
2. Видит поля для различных каналов связи:
   - Основной телефон
   - WhatsApp
   - Telegram
   - Instagram
   - VK
   - Яндекс.Карты
   - 2GIS
   - Сайт (если есть)
3. Арендатор добавляет/обновляет контактную информацию
4. Система валидирует форматы (телефон, URL и т.д.)
5. Сохраняет изменения
6. На карте и в информации павильона отображаются иконки с ссылками
7. При клике на иконку посетитель может открыть чат или написать

Альтернативный поток 1: Верификация контактов
- Система может запросить верификацию (отправить SMS)
- Убеждается, что контакт реально принадлежит павильону

Альтернативный поток 2: Приватный контакт
- Некоторые контакты можно скрыть от посетителей
- Показать только авторизованным пользователям

Постусловия:
- Контактные данные обновлены
- Посетители могут связаться с павильоном
- Ссылки на соц.сети открываются корректно


================================================================================
                    СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ - СУПЕР-АДМИН
================================================================================

USE CASE 11: АВТОРИЗАЦИЯ СУПЕР-АДМИНА
──────────────────────────────────────

Предусловия:
- Супер-админ открыл страницу входа (superadmin.html)
- У него есть учетные данные для доступа
- Система безопасности активна

Основной поток событий:
1. Супер-админ переходит на страницу superadmin.html
2. Вводит:
   - Логин (обычно специальная строка или email)
   - Пароль
   - ОБЯЗАТЕЛЬНО: двухфакторную аутентификацию (2FA) - включена по умолчанию для супер-админа
4. Нажимает "Войти"
5. Система проверяет учетные данные
6. Система запрашивает второй фактор аутентификации (SMS, приложение-аутентификатор или другой метод)
7. Если учетные данные и 2FA верны, система выпускает токен доступа
8. Супер-админ перенаправляется на админ-панель
7. Отображается полный доступ ко всем функциям системы
8. Логируется попытка входа (для аудита)

Альтернативный поток 1: Неверные учетные данные
- Система показывает ошибку "Неверный логин или пароль"
- Ограничивает количество попыток входа
- После 5 неудачных попыток блокирует аккаунт на время

Альтернативный поток 2: Двухфакторная аутентификация
- После ввода пароля запрашивается второй фактор
- Может быть SMS-код, код из приложения или биометрия
- Без второго фактора доступ не предоставляется

Постусловия:
- Супер-админ авторизован
- Есть полный доступ к системе
- Сеанс логируется для целей безопасности


USE CASE 12: УПРАВЛЕНИЕ ПАВИЛЬОНАМИ (СУПЕР-АДМИН)
──────────────────────────────────────────────────

Предусловия:
- Супер-админ авторизован
- Находится в админ-панели
- Есть база данных с павильонами

Основной поток событий:
1. Супер-админ переходит в раздел "Павильоны" или "Управление товаром"
2. Видит таблицу со всеми павильонами:
   - Название
   - Статус (активен, неактивен, требует модерации)
   - Арендатор (владелец)
   - Дата создания
   - Количество просмотров
3. Может отфильтровать по:
   - Статусу
   - Арендатору
   - Дате добавления
   - Поиск по названию
4. Заполните нужный павильон
5. Может:
   - Просмотреть полную информацию
   - Редактировать данные
   - Активировать/деактивировать
   - Удалить (с запросом подтверждения)
   - Дать/отобрать статус "премиум"
6. Все изменения сохраняются и логируются

Альтернативный поток 1: Модерация павильона
- Если павильон требует проверки, супер-админ может:
  - Просмотреть отмеченные проблемы
  - Одобрить или отклонить
  - Оставить комментарий с причиной

Альтернативный поток 2: Массовые операции
- Супер-админ может выбрать несколько павильонов
- Применить действие ко всем сразу (активировать, изменить категорию и т.д.)

Альтернативный поток 3: Восстановление павильона
- Если павильон удален, супер-админ может восстановить его
- Проверяется история изменений

Постусловия:
- Павильон отредактирован или удален
- Изменения применены
- Логирована операция


USE CASE 13: УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ И АРЕНДАТОРАМИ
───────────────────────────────────────────────────────

Предусловия:
- Супер-админ авторизован
- Находится в админ-панели
- Есть база данных с пользователями

Основной поток событий:
1. Супер-админ переходит в раздел "Пользователи" или "Арендаторы"
2. Видит таблицу со всеми пользователями:
   - Номер телефона
   - Имя/никнейм
   - Статус (активен, заблокирован, требует проверки)
   - Роль (посетитель, арендатор, премиум)
   - Дата регистрации
   - Кол-во павильонов
3. Может отфильтровать по:
   - Роли
   - Статусу
   - Типу (только арендаторы или все)
   - Поиск по телефону/имени
4. Выбирает пользователя
5. Может:
   - Просмотреть профиль
   - Редактировать данные
   - Заблокировать/разблокировать
   - Подтвердить как арендатора
   - Выдать/отобрать статус "премиум"
   - Выдать статус "владелец" (is_owner = true)
   - Удалить учетную запись
6. Может отправить сообщение пользователю

Альтернативный поток 1: Проверка подозрительной активности
- Супер-админ может просмотреть залм пользователя
- История изменений, попытки входа
- История покупок/использованных скидок

Альтернативный поток 2: Помощь пользователю
- Супер-админ может сбросить пароль пользователя
- Синхронизировать данные вручную
- Восстановить удаленные данные

Альтернативный поток 3: Массовая блокировка
- Супер-админ может заблокировать нескольких пользователей
- Например, за спам или нарушение правил

Постусловия:
- Данные пользователя обновлены
- Статус пользователя изменен
- Операция залогирована


USE CASE 14: ПРОСМОТР АНАЛИТИКИ И ОТЧЕТОВ
───────────────────────────────────────────

Предусловия:
- Супер-админ авторизован
- Система собирает аналитику и логи
- Есть достаточно данных для анализа

Основной поток событий:
1. Супер-админ переходит в раздел "Аналитика" или "Отчеты"
2. Видит панель с основными метриками:
   - Общее количество посетителей
   - Количество активных павильонов
   - Количество активных арендаторов
   - Количество использованных скидок
   - Среднее время на сайте
   - Популярные категории
3. Может просмотреть графики:
   - Активность по дням/неделям/месяцам
   - Распределение посетителей по категориям
   - Топ павильонов по просмотрам
   - Топ скидок по использованиям
4. Может выбрать период анализа (неделя, месяц, год)
5. Может сравнить периоды
6. Может экспортировать отчет (PDF, Excel)
7. Может посмотреть функцию "Что растет / что падает"

Альтернативный поток 1: Пользовательское отчеты
- Супер-админ может создать пользовательский отчет
- Выбрать метрики, параметры, период
- Сохранить шаблон для повторного использования
- Автоматически отправлять отчет по расписанию

Альтернативный поток 2: Детальный анализ по павильону
- Можно выбрать конкретный павильон
- Просмотреть его статистику отдельно
- Сравнить с другими павильонами

Альтернативный поток 3: Анализ проблем
- Система может автоматически найти аномалии
- Например, внезапное падение активности
- Рекомендует возможные причины

Постусловия:
- Супер-админ видит полную аналитику системы
- Может принять решения по развитию
- Информация актуальна и достоверна


USE CASE 15: УПРАВЛЕНИЕ БАЗОЙ ДАННЫХ И СИНХРОНИЗАЦИЕЙ
──────────────────────────────────────────────────────

Предусловия:
- Супер-админ авторизован
- Требуется техническое обслуживание системы
- Есть права на управление БД

Основной поток событий:
1. Супер-админ переходит в раздел "Система" или "Общие настройки"
2. Видит опции управления:
   - Синхронизация данных
   - Резервные копии
   - Очистка пустых записей
   - Перестроение индексов
   - Логирование
   - Настройки безопасности
3. Может запустить процесс синхронизации данных
4. Может создать ручную резервную копию
5. Может просмотреть логи ошибок
6. Может очистить устаревшие данные (с подтверждением)
7. Может просмотреть историю всех операций в системе
8. Может экспортировать данные для внешней обработки

Альтернативный поток 1: Восстановление из резервной копии
- Если произойдет сбой, супер-админ может восстановить данные
- Выбрать точку восстановления (дата/время)
- Система проверяет целостность перед восстановлением

Альтернативный поток 2: Миграция данных
- При обновлении структуры БД
- Супер-админ может запустить скрипт миграции
- Система проверяет совместимость данных

Альтернативный поток 3: Настройка уведомлений
- Супер-админ получает алерты о проблемах
- Может настроить каналы отправки (Email, SMS, Telegram)
- Установить пороги для автоматических уведомлений

Постусловия:
- БД в актуальном состоянии
- Все данные синхронизированы
- Резервная копия создана
- Система готова к работе


================================================================================
                           КРОССФУНКЦИОНАЛЬНЫЕ СЦЕНАРИИ
================================================================================

USE CASE 16: АВТОРИЗАЦИЯ И БЕЗОПАСНОСТЬ (ВСЕ АКТОРЫ)
─────────────────────────────────────────────────────

Предусловия:
- Пользователь пытается получить доступ к защищенной функции
- Система безопасности активна

Основной поток событий:
1. Система проверяет тип доступа (публичный или требует авторизации)
2. Если требуется авторизация:
   - Система перенаправляет на страницу входа
   - Пользователь выбирает тип авторизации (телефон, email, социальные сети)
   - Вводит данные
   - Подтверждает личность (SMS-код, email-ссылка)
   - Получает токен доступа (JWT с TTL)
3. Токен сохраняется локально (localStorage или sessionStorage)
4. Токен отправляется с каждым запросом к защищенным ресурсам
5. Сервер проверяет валидность токена
6. Если токен истек, система запрашивает повторную авторизацию
7. При выходе токен удаляется

Альтернативный поток 1: Социальная авторизация
- Пользователь может войти через Яндекс, ВКонтакте, Telegram
- Система редиректит на провайдера
- Получает данные пользователя от провайдера
- Создает или обновляет профиль в своей системе
- ВАЖНО: Социальная авторизация необходима для владельцев, арендаторов и пользователей, чтобы была возможность делиться контентом (изображения, товары, локации, павильоны) в своих соц.сетях
- Это поможет в будущем реализовать реферальную программу

Альтернативный поток 2: Биометрическая авторизация
- Молодые браузеры поддерживают WebAuthn
- Пользователь может использовать отпечаток пальца или лицо
- Безопаснее, чем пароль

Альтернативный поток 3: Восстановление доступа
- Если пользователь утратил доступ (потеря номера телефона)
- Может использовать резервные способы восстановления
- Например, email или вопросы безопасности

Постусловия:
- Пользователь авторизован (если необходимо)
- Может получить доступ к защищенным функциям
- Сеанс логируется
- Безопасность соблюдена


USE CASE 17: ОБЩЕЕ УПРАВЛЕНИЕ ПОМЕЩЕНИЯМИ И ЭТАЖАМИ
──────────────────────────────────────────────────────

Предусловия:
- Супер-админ авторизован
- Требуется добавить новое здание или этаж
- Есть координаты помещений

Основной поток событий:
1. Супер-админ переходит в раздел "Здания" или "Планы этажей"
2. Видит список существующих зданий/торговых центров
3. Может выбрать существующее здание для редактирования
4. Загружает новое изображение плана этажа (если нужно)
5. Указывает координаты павильонов на плане:
   - Загружает изображение плана
   - Отмечает точки/области для павильонов
   - Привязывает павильоны с БД к точкам на плане
6. Сохраняет план
7. План становится видна на карте для посетителей

Альтернативный поток 1: Добавление нового здания
- Супер-админ может добавить полностью новое здание
- Загрузить все этажи за один раз
- Составить геокоординаты

Альтернативный поток 2: Интеграция с 2GIS / Яндекс.Карты
- ВАЖНО: Интеграция необходима для получения готовых карт и планов этажей
- Система может подтягивать координаты и изображения планов из внешних источников (2GIS, Яндекс.Карты)
- Автоматически разместить павильоны на карте без необходимости ручной отрисовки
- Сокращает время на настройку новых локаций и обновление существующих

Постусловия:
- План этажа обновлен
- Павильоны правильно размещены на плане
- Посетители видят актуальную карту


================================================================================
                       СИСТЕМНЫЕ ТРЕБОВАНИЯ И ОГРАНИЧЕНИЯ
================================================================================

ПРОИЗВОДИТЕЛЬНОСТЬ:
- Карта должна загружаться за < 3 секунды
- Поиск должен выполняться в реальном времени (< 100ms)
- Приложение должно работать в режиме offline (PWA)

БРАУЗЕРЫ:
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+
- Mobile: iOS Safari 14+, Chrome Mobile

БЕЗОПАСНОСТЬ:
- Все данные передаются по HTTPS
- Пароли хранятся в хешированном виде (bcrypt)
- SMS-коды отправляются через защищенный канал
- SQL-injection защита (подготовленные statements)

МАСШТАБИРУЕМОСТЬ:
- Система должна выдержать 10,000+ одновременных пользователей
- БД оптимизирована с индексами для быстрого поиска
- CDN используется для статических ресурсов

ДОСТУПНОСТЬ:
- Приложение должно быть доступно 99.9% времени
- Есть система мониторинга и alerting
- Возможность быстрого восстановления после сбоя


================================================================================
                 ЮРИДИЧЕСКИЕ ТРЕБОВАНИЯ И СОГЛАШЕНИЯ (РФ)
================================================================================

В соответствии с законодательством Российской Федерации приложение должно
требовать согласия пользователей на ряд важных вопросов безопасности и прав.

╔═════════════════════════════════════════════════════════════════════════════╗
║        USE CASE 15: СОГЛАСИЕ НА ОБРАБОТКУ ПЕРСОНАЛЬНЫХ ДАННЫХ              ║
╚═════════════════════════════════════════════════════════════════════════════╝

Нормативная база:
- Федеральный закон "О защите персональных данных" №152-ФЗ
- ГПДР (если в приложении международные пользователи)

Предусловия:
- Пользователь заходит в приложение в первый раз
- Пользователь создает учетную запись (регистрация)
- Система требует явного согласия на обработку данных

Основной поток событий:
1. Система отображает модальное окно "Согласие на обработку персональных данных"
2. Пользователь видит полный текст соглашения:

   ┌─────────────────────────────────────────────────────────────────────┐
   │ СОГЛАСИЕ НА ОБРАБОТКУ ПЕРСОНАЛЬНЫХ ДАННЫХ                          │
   ├─────────────────────────────────────────────────────────────────────┤
   │                                                                     │
   │ Я, нижеподписанный, даю свое согласие организации                 │
   │ (далее "Компания") на обработку своих персональных данных          │
   │ в соответствии с Федеральным законом "О защите персональных       │
   │ данных" №152-ФЗ от 27 июля 2006 года.                             │
   │                                                                     │
   │ ПРОЦЕССЫ ОБРАБОТКИ:                                                │
   │ ✓ Сбор и хранение контактной информации (телефон, имя)           │
   │ ✓ Отправка SMS с кодом подтверждения для аутентификации          │
   │ ✓ Анализ поведения пользователя для улучшения сервиса            │
   │ ✓ Отправка уведомлений о новых скидках и предложениях            │
   │ ✓ Ведение статистики посещений и взаимодействия                  │
   │                                                                     │
   │ ЦЕЛЯМИ ОБРАБОТКИ:                                                  │
   │ ✓ Идентификация и аутентификация пользователя                    │
   │ ✓ Обеспечение функциональности сервиса                           │
   │ ✓ Исполнение договорных обязательств                            │
   │ ✓ Безопасность и предотвращение мошенничества                   │
   │ ✓ Улучшение качества сервиса и пользовательского опыта         │
   │                                                                     │
   │ КАТЕГОРИИ ДАННЫХ:                                                   │
   │ ✓ Идентификационные: имя, фамилия, номер телефона               │
   │ ✓ Технические: IP-адрес, тип браузера, ОС                       │
   │ ✓ Поведенческие: клики, просмотры павильонов, поиски            │
   │ ✓ Финансовые: информация о скидках и покупках                   │
   │                                                                     │
   │ СРОКИ ОБРАБОТКИ:                                                    │
   │ ✓ В течение деятельности сервиса                                 │
   │ ✓ 3 года после последнего входа (архивирование)                 │
   │ ✓ Полное удаление по запросу пользователя                       │
   │                                                                     │
   │ ПОДТВЕРЖДАЮ, что:                                                  │
   │ ✓ Ознакомлен(-а) с полной информацией об обработке             │
   │ ✓ Даю добровольное и осознанное согласие                        │
   │ ✓ Могу отозвать согласие в любой момент                        │
   │                                                                     │
   │ ☐ Я согласен(-а) на обработку моих персональных данных          │
   │ ☐ Я согласен(-а) получать уведомления по телефону               │
   │ ☐ Я согласен(-а) на использование данных для аналитики          │
   │                                                                     │
   │ [ОТКЛОНИТЬ]  [✓ ПРИНЯТЬ И ПРОДОЛЖИТЬ]                            │
   │                                                                     │
   └─────────────────────────────────────────────────────────────────────┘

3. Пользователь может прочитать всю информацию (скролл)
4. Пользователь ставит галочку(и) для согласия
5. Если не все три чекбокса отмечены, кнопка "ПРИНЯТЬ" неактивна (disabled)
6. При нажатии "ОТКЛОНИТЬ" - пользователь не может создать учетную запись
7. При нажатии "ПРИНЯТЬ" - система сохраняет время и дату согласия в БД

Альтернативный поток 1: Пользователь отклоняет согласие
- Система показывает сообщение: "Без согласия невозможно использовать сервис"
- Регистрация отменяется
- Пользователь может вернуться и принять согласие в любой момент

Альтернативный поток 2: Пользователь хочет отозвать согласие
- На странице профиля доступна опция "Управление согласиями"
- Пользователь может отозвать согласие
- После отзыва некоторые функции могут быть ограничены

Постусловия:
- Согласие принято и зафиксировано в системе с timestamp
- Пользователь может продолжить использование сервиса
- Система имеет право на обработку данных согласно условиям


╔═════════════════════════════════════════════════════════════════════════════╗
║        USE CASE 16: СОГЛАСИЕ С УСЛОВИЯМИ ИСПОЛЬЗОВАНИЯ (TERMS OF SERVICE)  ║
╚═════════════════════════════════════════════════════════════════════════════╝

Нормативная база:
- Федеральный закон "О защите прав потребителей" №2300-1
- Гражданский кодекс РФ (договор публичной оферты)

Предусловия:
- Пользователь проходит регистрацию
- Система выводит пользовательское соглашение

Основной поток событий:
1. Система отображает модальное окно "Условия использования"
2. Пользователь видит полный текст:

   ┌─────────────────────────────────────────────────────────────────────┐
   │ УСЛОВИЯ ИСПОЛЬЗОВАНИЯ СЕРВИСА (User Agreement)                    │
   ├─────────────────────────────────────────────────────────────────────┤
   │                                                                     │
   │ 1. ОПРЕДЕЛЕНИЯ И ОБЩИЕ ПОЛОЖЕНИЯ                                  │
   │    - "Сервис" - веб-приложение Apraxin Map и все его компоненты   │
   │    - "Пользователь" - любое физическое или юридическое лицо       │
   │    - "Контент" - информация о павильонах, скидках, товарах        │
   │                                                                     │
   │ 2. ПРАВОВОЙ СТАТУС СОГЛАШЕНИЯ                                     │
   │    - Это публичная оферта согласно ст. 435-456 ГК РФ             │
   │    - Использование сервиса означает принятие всех условий        │
   │    - Соглашение может быть изменено в любой момент               │
   │    - Существующие пользователи будут уведомлены об изменениях   │
   │                                                                     │
   │ 3. ПРАВА И ОБЯЗАННОСТИ ПОЛЬЗОВАТЕЛЯ                               │
   │    ПРАВА:                                                          │
   │    ✓ Свободно просматривать информацию о павильонах             │
   │    ✓ Использовать функцию поиска и фильтрации                  │
   │    ✓ Создавать личный кабинет (для арендаторов)                │
   │    ✓ Запрашивать поддержку через контактные формы               │
   │    ✓ Отозвать согласие и удалить свой аккаунт                 │
   │                                                                     │
   │    ОБЯЗАННОСТИ:                                                    │
   │    ✓ Предоставлять достоверную информацию при регистрации      │
   │    ✓ Соблюдать законодательство РФ                             │
   │    ✓ Не передавать пароль третьим лицам                        │
   │    ✓ Не использовать сервис в противоправных целях            │
   │    ✓ Не осуществлять автоматический доступ без разрешения     │
   │    ✓ Не распространять спам и вредоносный контент             │
   │                                                                     │
   │ 4. ЗАПРЕЩЕННАЯ ДЕЯТЕЛЬНОСТЬ                                       │
   │    ✗ Попытки взлома или проникновения в систему                │
   │    ✗ Распространение вредоноса и вирусов                       │
   │    ✗ Скрепинг и автоматический доступ (кроме RSS)             │
   │    ✗ Размещение незаконного контента                           │
   │    ✗ Преследование, угрозы, оскорбления других пользователей  │
   │    ✗ Коммерческое использование без согласования               │
   │                                                                     │
   │ 5. ОТВЕТСТВЕННОСТЬ КОМПАНИИ                                        │
   │    - Сервис предоставляется "как есть" (AS IS)                  │
   │    - Компания не гарантирует бесперебойную работу              │
   │    - Компания не несет ответственность за убытки пользователей │
   │    - Максимальная ответственность - возврат платежа             │
   │                                                                     │
   │ 6. ИНТЕЛЛЕКТУАЛЬНАЯ СОБСТВЕННОСТЬ                                 │
   │    - Все материалы защищены авторским правом                    │
   │    - Лицензия на использование: CC BY-NC (неком. распространение)│
   │    - Без письменного согласия копирование запрещено             │
   │                                                                     │
   │ 7. РАЗРЕШЕНИЕ СПОРОВ И ПРИМЕНИМОЕ ПРАВО                           │
   │    - Закон РФ                                                    │
   │    - Юрисдикция: суды СПб и Ленинградской области             │
   │    - При желании: арбитраж МежПАК                               │
   │                                                                     │
   │ ☐ Я полностью прочитал(-а) условия использования                 │
   │ ☐ Я согласен(-а) со всеми условиями                             │
   │ ☐ Я принимаю полную ответственность за свои действия            │
   │                                                                     │
   │ [ОТКЛОНИТЬ]  [✓ ПРИНЯТЬ И ПРОДОЛЖИТЬ]                            │
   │                                                                     │
   └─────────────────────────────────────────────────────────────────────┘

Постусловия:
- Пользовательское согласие зафиксировано
- Пользователь может использовать все функции сервиса


╔═════════════════════════════════════════════════════════════════════════════╗
║              USE CASE 17: ПОЛИТИКА КОНФИДЕНЦИАЛЬНОСТИ                       ║
╚═════════════════════════════════════════════════════════════════════════════╝

Содержание политики конфиденциальности:

   ┌─────────────────────────────────────────────────────────────────────┐
   │ ПОЛИТИКА КОНФИДЕНЦИАЛЬНОСТИ                                        │
   ├─────────────────────────────────────────────────────────────────────┤
   │                                                                     │
   │ ПРИНЦИПЫ КОНФИДЕНЦИАЛЬНОСТИ:                                       │
   │ 1. Минимизация данных - собираем только необходимое              │
   │ 2. Безопасность - используем HTTPS и шифрование                  │
   │ 3. Прозрачность - полная информация о сборе и использовании      │
   │ 4. Контроль - пользователь может управлять своими данными        │
   │                                                                     │
   │ КАКИЕ ДАННЫЕ СОБИРАЮТСЯ:                                          │
   │ ┌──────────────────────────────────────────────────────────────┐  │
   │ │ КАТЕГОРИЯ          │ ПРИМЕРЫ              │ ОБЯЗАТЕЛЬНО    │  │
   │ ├──────────────────────────────────────────────────────────────┤  │
   │ │ Идентификация      │ Имя, телефон, почта  │ Да (для входа) │  │
   │ │ Учетные данные     │ Пароль (хеш)         │ Да            │  │
   │ │ Технические данные │ IP, User-Agent       │ Автоматически│  │
   │ │ Использование      │ Клики, страницы      │ Да (для UX)   │  │
   │ │ Местоположение*    │ Город (из IP)        │ Нет           │  │
   │ │ Платежи*           │ Трансакции           │ Только если   │  │
   │ │                    │                      │ применимо     │  │
   │ └──────────────────────────────────────────────────────────────┘  │
   │                                                                     │
   │ БЕЗОПАСНОСТЬ ДАННЫХ:                                              │
   │ ✓ Все передачи по HTTPS (TLS 1.3)                               │
   │ ✓ Пароли хронятся в хешированном виде (bcrypt)                 │
   │ ✓ Доступ ограничен только необходимым сотрудникам             │
   │ ✓ Регулярные аудиты безопасности и тестирование               │
   │ ✓ Резервные копии с шифрованием                               │
   │                                                                     │
   │ ПРАВА И ЗАПРОСЫ ПОЛЬЗОВАТЕЛЯ:                                    │
   │ ✓ Право на доступ - получить все данные о себе                │
   │ ✓ Право на исправление - обновить неверные данные             │
   │ ✓ Право на удаление - удалить все данные ("right to be       │
   │   forgotten")                                                      │
   │ ✓ Право на ограничение обработки - запретить определенные     │
   │   операции                                                        │
   │ ✓ Право на портативность - получить данные в общем формате    │
   │                                                                     │
   │ СРОКИ ХРАНЕНИЯ:                                                    │
   │ • Активные аккаунты: весь период использования + 3 года        │
   │ • Неактивные аккаунты: 1 год с последнего входа               │
   │ • Аналитика: 1 год (в агрегированном виде)                    │
   │ • Логи безопасности: 6 месяцев                                 │
   │ • Рекламные данные: 90 дней                                    │
   │                                                                     │
   │ ТРАНСГРАНИЧНЫЕ ПЕРЕДАЧИ:                                         │
   │ При необходимости передача в иные страны ТОЛЬКО с согласием    │
   │ пользователя и при обеспечении эквивалентной защиты.           │
   │ На данный момент все данные хранятся в РФ (Supabase Москва).  │
   │                                                                     │
   │ COOKIES И ОТСЛЕЖИВАНИЕ:                                          │
   │ • Функциональные cookies: для работы сервиса (необходимые)     │
   │ • Аналитические: Google Analytics (можно отключить)            │
   │ • Рекламные: отключены по умолчанию                           │
   │                                                                     │
   │ ☐ Я ознакомлен(-а) с политикой конфиденциальности              │
   │                                                                     │
   └─────────────────────────────────────────────────────────────────────┘

Действие: Пользователь должен отметить согласие с политикой.


╔═════════════════════════════════════════════════════════════════════════════╗
║              USE CASE 18: УПРАВЛЕНИЕ СОГЛАСИЯМИ И СОГЛАШЕНИЯМИ             ║
╚═════════════════════════════════════════════════════════════════════════════╝

Предусловия:
- Пользователь авторизован в системе
- Пользователь имеет активный аккаунт
- Доступна страница "Настройки" или "Управление данными"

Основной поток событий:
1. Пользователь переходит в личный кабинет → "Настройки" → "Согласия"
2. Система отображает панель управления согласиями:

   ┌─────────────────────────────────────────────────────────────────────┐
   │ УПРАВЛЕНИЕ СОГЛАСИЯМИ И УВЕДОМЛЕНИЯМИ                             │
   ├─────────────────────────────────────────────────────────────────────┤
   │                                                                     │
   │ АКТИВНЫЕ СОГЛАСИЯ:                                                  │
   │ ┌─────────────────────────────────────────────────────────────────┐ │
   │ │ ☑ Согласие на обработку ПД                                     │ │
   │ │   Принято: 11.02.2026, 14:32                                   │ │
   │ │   Статус: Активно                                              │ │
   │ │   [ПРОСМОТР ТЕКСТА]  [ОТОЗВАТЬ]                               │ │
   │ │                                                                 │ │
   │ │ ☑ Условия использования сервиса                               │ │
   │ │   Принято: 11.02.2026, 14:32                                   │ │
   │ │   Версия: 1.5 (от 01.02.2026)                                │ │
   │ │   [ПРОСМОТР ТЕКСТА]  [ОТОЗВАТЬ]  [ОБНОВИТЬ]                  │ │
   │ │                                                                 │ │
   │ │ ☑ Политика конфиденциальности                                 │ │
   │ │   Принято: 11.02.2026, 14:32                                   │ │
   │ │   Версия: 2.1 (от 01.01.2026)                                │
   │ │   [ПРОСМОТР ТЕКСТА]  [ОТОЗВАТЬ]                               │ │
   │ │                                                                 │ │
   │ │ ☑ Согласие на маркетинговые коммуникации                      │ │
   │ │   Принято: 11.02.2026, 14:32                                   │ │
   │ │   Статус: Разрешены по почте и SMS                           │ │
   │ │   [УПРАВЛЯТЬ ТИПАМИ]  [ОТОЗВАТЬ]                             │ │
   │ └─────────────────────────────────────────────────────────────────┘ │
   │                                                                     │
   │ УПРАВЛЕНИЕ КОММУНИКАЦИЯМИ:                                         │
   │ ┌─────────────────────────────────────────────────────────────────┐ │
   │ │ ☑ Получать SMS с новыми скидками                              │ │
   │ │ ☑ Получать email рассылку                                     │ │
   │ │ ☐ Получать push-уведомления                                   │ │
   │ │ ☐ Использовать данные для персонализированной рекламы         │ │
   │ │                                                                 │ │
   │ │ [СОХРАНИТЬ ИЗМЕНЕНИЯ]                                          │ │
   │ └─────────────────────────────────────────────────────────────────┘ │
   │                                                                     │
   │ УПРАВЛЕНИЕ ЛИЧНЫМИ ДАННЫМИ:                                        │
   │ ┌─────────────────────────────────────────────────────────────────┐ │
   │ │ [СКАЧАТЬ МОИ ДАННЫЕ] (JSON/CSV)                               │ │
   │ │ [УДАЛИТЬ МОЙ АККАУНТ] (с подтверждением)                      │ │
   │ │ [ЗАПРОСИТЬ ДОСТУП К АРХИВУ] (для ГПДР)                       │ │
   │ │                                                                 │ │
   │ │ ⚠️ ВНИМАНИЕ: Эти действия необратимы!                         │ │
   │ └─────────────────────────────────────────────────────────────────┘ │
   │                                                                     │
   │ ИСТОРИЯ СОГЛАСИЙ:                                                   │
   │ ┌────────────────────────────────────────────────────────────────┐  │
   │ │ Дата        │ Событие                │ Статус    │ IP Адрес   │  │
   │ ├────────────────────────────────────────────────────────────────┤  │
   │ │ 11.02.26    │ Принято ПД согласие    │ Активно   │ 123.45.6.7 │  │
   │ │ 20.01.26    │ Отозвано маркетинг     │ Отозвано  │ 123.45.6.7 │  │
   │ │ 15.10.25    │ Обновлено Terms of Use │ Актуально │ 78.90.1.23 │  │
   │ └────────────────────────────────────────────────────────────────┘  │
   │                                                                     │
   └─────────────────────────────────────────────────────────────────────┘

Альтернативный поток 1: Отозвание согласия
- Пользователь нажимает "ОТОЗВАТЬ"
- Система запрашивает подтверждение
- После подтверждения согласие деактивируется
- Сервис может ограничить функции, требующие этого согласия

Альтернативный поток 2: Обновление согласия
- Если соглашение изменилось, система показывает уведомление
- При переходе на защищенные функции требуется принять новую версию
- Пользователь видит разницу между старой и новой версией

Постусловия:
- Согласия обновлены согласно желаниям пользователя
- История хранится в системе для аудита
- Система соблюдает все указанные предпочтения


╔═════════════════════════════════════════════════════════════════════════════╗
║            ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ К РАБОТЕ СОГЛАСИЙ                        ║
╚═════════════════════════════════════════════════════════════════════════════╝

БАЗА ДАННЫХ (в таблице "consents"):
─────────────────────────────────────
CREATE TABLE consents (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  consent_type VARCHAR(50),  -- 'personal_data', 'terms', 'privacy', 'marketing'
  consent_text_version VARCHAR(10),  -- версия текста соглашения
  accepted BOOLEAN,  -- true если принято, false если отозвано
  accepted_at TIMESTAMP,
  revoked_at TIMESTAMP NULL,
  ip_address VARCHAR(45),  -- для аудита и безопасности
  user_agent TEXT,  -- браузер и ОС
  location VARCHAR(100),  -- город/страна из IP (если доступно)
  notes TEXT,  -- комментарии администратора
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_consents_user ON consents(user_id);
CREATE INDEX idx_consents_type ON consents(consent_type);


ФРОНТЕНД КОМПОНЕНТЫ:
────────────────────
1. ConsentModal - модальное окно первоначального согласия
2. ConsentCheckbox - чекбокс для каждого согласия
3. ConsentManagementPanel - панель управления согласиями
4. ConsentHistory - история согласий пользователя
5. ConsentBanner - уведомление об обновлении соглашения

Каждый компонент должен иметь:
- Полный текст соглашения
- Версию соглашения
- Дату последнего обновления
- Ссылку на полный текст на отдельной странице
- Возможность отозвать согласие
- Логирование действий пользователя

ПРАВИЛА ВАЛИДАЦИИ:
──────────────────
• Для регистрации: ОБЯЗАТЕЛЬНО принять "Согласие на ПД" и "Terms of Use"
• Для использования некоторых функций: требуется "Политика конфиденциальности"
• Для рассылок: требуется отдельное согласие на маркетинг
• Все согласия должны быть явные (opt-in), не неявные (opt-out)

УВЕДОМЛЕНИЯ ОБ ИЗМЕНЕНИЯХ:
──────────────────────────
1. При изменении любого соглашения:
   - Отправить email всем активным пользователям
   - Показать уведомление в личном кабинете
   - При доступе к защищенным функциям - требовать новое согласие
   
2. При истечении согласия:
   - Отправить напоминание за 14 дней
   - Деактивировать функции за 7 дней

СООТВЕТСТВИЕ ЗАКОНОДАТЕЛЬСТВУ:
───────────────────────────────
✓ 152-ФЗ "О защите персональных данных" (Россия)
✓ 2300-1 "О защите прав потребителей" (Россия)
✓ ГПДР (Европа) - при наличии пользователей из ЕС
✓ Постановление ФАС от 14.03.2014 - о согласиях


================================================================================
                              ЗАКЛЮЧЕНИЕ
================================================================================

Документ описывает основные сценарии использования приложения Apraxin Map
с точки зрения трех основных групп пользователей: Посетителей, Арендаторов
и Супер-администраторов.

Каждый сценарий содержит:
- Предусловия (что должно быть верно в начале)
- Основной поток (стандартная последовательность шагов)
- Альтернативные потоки (исключения и вариации)
- Постусловия (результат успешного выполнения)

Система разработана с учетом удобства пользователей, безопасности данных,
масштабируемости для растущей аудитории и ПОЛНОГО СООТВЕТСТВИЯ
ЗАКОНОДАТЕЛЬСТВУ РОССИЙСКОЙ ФЕДЕРАЦИИ в области защиты персональных данных,
защиты прав потребителей и конфиденциальности.

================================================================================
