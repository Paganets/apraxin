<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ê–ø—Ä–∞—à–∫–∏ ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–≤–∏–ª—å–æ–Ω–∞–º–∏ –∏ —Å–∫–∏–¥–∫–∞–º–∏">
    <meta name="theme-color" content="#000000">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ö–∞—Ä—Ç–∞ –ê–ø—Ä–∞—à–∫–∏</title>
    
    <!-- Supabase Configuration (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ meta —Ç–µ–≥–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏) -->
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ3B1dWNkbmtyendzbW5ieW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDMxMjYsImV4cCI6MjA4NjA3OTEyNn0.T3vEY9VfxIQ19AtWPkwk6xiqAZe6sEzG-Ke73olUPsY">
    <meta name="supabase-url" content="https://qagpuucdnkrzwsmnbymk.supabase.co">
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Supabase –∏–∑ <meta> —Ç–µ–≥–æ–≤ -->
    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Supabase –∏–∑ <meta> —Ç–µ–≥–æ–≤
      window.SupabaseConfig = {
        url: document.querySelector('meta[name="supabase-url"]').content,
        anonKey: document.querySelector('meta[name="supabase-anon-key"]').content
      };
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- –®–ê–ü–ö–ê –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò -->
    <header class="admin-header">
        <div class="admin-header-title">
            <h1>üè¢ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        </div>
        <div class="admin-header-user" id="user-info">
            <span id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button class="btn btn-primary" onclick="handleLogout()">üö™ –í—ã—Ö–æ–¥</button>
        </div>
    </header>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
    <main class="app-main">
        <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-pavilions">0</div>
                <div class="stat-label">–ü–∞–≤–∏–ª—å–æ–Ω–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-discounts">0</div>
                <div class="stat-label">–°–∫–∏–¥–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-views">0</div>
                <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
            </div>
        </section>

        <!-- –û–°–ù–û–í–ù–ê–Ø –†–ê–ó–ú–ï–¢–ö–ê: –î–í–ï –ö–û–õ–û–ù–ö–ò -->
        <div class="admin-container">
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –§–û–†–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
            <div class="edit-panel">
                <h2 class="admin-section-title">‚úèÔ∏è –ü–∞–≤–∏–ª—å–æ–Ω</h2>

                <form id="pavilion-form">
                    <!-- –≠–¢–ê–ñ -->
                    <div class="form-group">
                        <label for="floor-input">–≠—Ç–∞–∂</label>
                        <select id="floor-input" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂</option>
                            <option value="1">1 —ç—Ç–∞–∂</option>
                            <option value="2">2 —ç—Ç–∞–∂</option>
                            <option value="3">3 —ç—Ç–∞–∂</option>
                            <option value="4">4 —ç—Ç–∞–∂</option>
                            <option value="5">5 —ç—Ç–∞–∂</option>
                        </select>
                    </div>

                    <!-- –ù–û–ú–ï–† –ü–ê–í–ò–õ–¨–û–ù–ê -->
                    <div class="form-group">
                        <label for="location-input">–ù–æ–º–µ—Ä –ø–∞–≤–∏–ª—å–æ–Ω–∞ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)</label>
                        <input type="text" id="location-input" readonly placeholder="–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ">
                    </div>

                    <!-- –ù–ê–ó–í–ê–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê -->
                    <div class="form-group">
                        <label for="name-input">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ *</label>
                        <input type="text" id="name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞" required>
                    </div>

                    <!-- –ö–ê–¢–ï–ì–û–†–ò–Ø -->
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <div class="category-chips" id="category-chips">
                            <button type="button" class="category-chip" data-category="clothing">üëï –û–¥–µ–∂–¥–∞</button>
                            <button type="button" class="category-chip" data-category="shoes">üëû –û–±—É–≤—å</button>
                            <button type="button" class="category-chip" data-category="accessories">‚ú® –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>
                            <button type="button" class="category-chip" data-category="electronics">üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</button>
                            <button type="button" class="category-chip" data-category="cosmetics">üíÑ –ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
                            <button type="button" class="category-chip" data-category="sports">‚öΩ –°–ø–æ—Ä—Ç</button>
                            <button type="button" class="category-chip" data-category="other">üì¶ –ü—Ä–æ—á–µ–µ</button>
                        </div>
                        <input type="hidden" id="category-input" required>
                    </div>

                    <!-- –¶–í–ï–¢ –ë–†–ï–ù–î–ò–†–û–í–ê–ù–ò–Ø -->
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç –±—Ä–µ–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                        <div class="color-palette" id="color-palette">
                            <div class="color-option" style="background: #E91E63" data-color="#E91E63" title="–†–æ–∑–æ–≤—ã–π"></div>
                            <div class="color-option" style="background: #9C27B0" data-color="#9C27B0" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></div>
                            <div class="color-option" style="background: #2196F3" data-color="#2196F3" title="–°–∏–Ω–∏–π"></div>
                            <div class="color-option" style="background: #00BCD4" data-color="#00BCD4" title="–ì–æ–ª—É–±–æ–π"></div>
                            <div class="color-option" style="background: #4CAF50" data-color="#4CAF50" title="–ó–µ–ª—ë–Ω—ã–π"></div>
                            <div class="color-option" style="background: #8BC34A" data-color="#8BC34A" title="–°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π"></div>
                            <div class="color-option" style="background: #FFC107" data-color="#FFC107" title="–ñ—ë–ª—Ç—ã–π"></div>
                            <div class="color-option" style="background: #FF9800" data-color="#FF9800" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></div>
                            <div class="color-option" style="background: #FF5722" data-color="#FF5722" title="–ö—Ä–∞—Å–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π"></div>
                            <div class="color-option" style="background: #F44336" data-color="#F44336" title="–ö—Ä–∞—Å–Ω—ã–π"></div>
                            <div class="color-option" style="background: #795548" data-color="#795548" title="–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π"></div>
                            <div class="color-option" style="background: #9E9E9E" data-color="#9E9E9E" title="–°–µ—Ä—ã–π"></div>
                        </div>
                        <input type="hidden" id="brand-color-input" value="#FF6B35">
                    </div>

                    <!-- –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø -->
                    <div class="form-group">
                        <label for="image-input">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–º–∞–∫—Å. 2 –ú–ë)</label>
                        <div class="image-upload-area" onclick="document.getElementById('image-input').click()">
                            <p>üì∏ –ö–ª–∏–∫–Ω–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                        </div>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <img id="image-preview" class="image-preview" style="display: none;">
                    </div>

                    <!-- –í–•–û–î–´ –í –ó–î–ê–ù–ò–ï -->
                    <div class="form-group">
                        <label>–í—Ö–æ–¥—ã –≤ –∑–¥–∞–Ω–∏–µ</label>
                        <div id="entrances-container" style="margin-bottom: var(--spacing-md);">
                            <div id="entrances-list">
                                <small>–í—Ö–æ–¥—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞–≤–∏–ª—å–æ–Ω–∞</small>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–û–û–†–î–ò–ù–ê–¢–´ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ) -->
                    <div class="form-group">
                        <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ</label>
                        <p style="font-size: var(--font-size-sm); color: var(--color-text-light);">
                            –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É —Å–ø—Ä–∞–≤–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                        </p>
                        <input type="hidden" id="pavilion-x">
                        <input type="hidden" id="pavilion-y">
                    </div>

                    <!-- –°–ö–ò–î–ö–ò -->
                    <div class="form-group">
                        <label>–°–∫–∏–¥–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</label>
                        <div id="discounts-container">
                            <div class="discounts-list" id="discounts-list">
                                <p style="color: var(--color-text-light); font-size: var(--font-size-sm);">
                                    –°–∫–∏–¥–æ–∫ –Ω–µ—Ç
                                </p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: var(--spacing-md);" onclick="showAddDiscountModal()">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É
                        </button>
                    </div>

                    <!-- –ö–ù–û–ü–ö–ò -->
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="reset" class="btn btn-secondary" style="flex: 1;">‚Ü∫ –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </form>
            </div>

            <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ü–†–ï–î–ü–†–û–ú–û–¢–† –ö–ê–†–¢–´ -->
            <div class="preview-panel">
                <h2 class="admin-section-title">üó∫Ô∏è –ö–∞—Ä—Ç–∞</h2>

                    <!-- –í–´–ë–û–† –≠–¢–ê–ñ–ê -->
                <div class="map-section">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂:</h3>
                    <div class="floor-selector" id="floor-selector">
                        <button class="floor-btn active" data-floor="1" onclick="selectFloor(1)">1 —ç—Ç–∞–∂</button>
                        <button class="floor-btn" data-floor="2" onclick="selectFloor(2)">2 —ç—Ç–∞–∂</button>
                        <button class="floor-btn" data-floor="3" onclick="selectFloor(3)">3 —ç—Ç–∞–∂</button>
                        <button class="floor-btn" data-floor="4" onclick="selectFloor(4)">4 —ç—Ç–∞–∂</button>
                        <button class="floor-btn" data-floor="5" onclick="selectFloor(5)">5 —ç—Ç–∞–∂</button>
                    </div>
                </div>

                <!-- –ö–ê–†–¢–ê –ú–ò–ù–ò–ê–¢–Æ–†–ê -->
                <div class="map-section">
                    <div class="map-container-mini" id="map-mini">
                        <div class="map-hint">
                            <p>üìç –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é –ø–∞–≤–∏–ª—å–æ–Ω–∞</p>
                        </div>
                        <!-- mini-map element required by admin.js -->
                        <div id="mini-map" style="width:100%; height:300px;"></div>
                    </div>
                </div>

                <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-bg-light); border-radius: var(--radius-md);">
                    <p style="font-size: var(--font-size-sm); margin: 0;">
                        <strong>üí° –°–æ–≤–µ—Ç:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —Å–ø—Ä–∞–≤–∞ –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∞—à–µ–≥–æ –ø–∞–≤–∏–ª—å–æ–Ω–∞. –ù–æ–º–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </p>
                </div>
            </div>
        </div>

        <!-- –°–ü–ò–°–û–ö –ü–ê–í–ò–õ–¨–û–ù–û–í -->
        <section class="pavilions-list-section">
            <h2 class="admin-section-title">üìã –ú–æ–∏ –ø–∞–≤–∏–ª—å–æ–Ω—ã</h2>
            
                <div style="overflow-x: auto;">
                <table class="pavilions-table" id="pavilions-table">
                    <thead>
                        <tr>
                            <th>–≠—Ç–∞–∂</th>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–°–∫–∏–¥–∫–∏</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="pavilions-table-body"></tbody>
                    <tbody id="pavilions-list">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-light);">
                                –ù–µ—Ç –ø–∞–≤–∏–ª—å–æ–Ω–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø–∞–≤–∏–ª—å–æ–Ω –≤—ã—à–µ.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –î–û–ë–ê–í–ò–¢–¨ –°–ö–ò–î–ö–£ -->
    <div id="discount-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–¥–∫—É</h3>
                <button class="modal-close" onclick="hideAddDiscountModal()">‚úï</button>
            </div>
            <form id="discount-form">
                <div class="form-group">
                    <label for="discount-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏ *</label>
                    <input type="text" id="discount-title" placeholder="24-—á–∞—Å–æ–≤–∞—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞" required>
                </div>
                <div class="form-group">
                    <label for="discount-desc">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                    <textarea id="discount-desc" placeholder="20% –Ω–∞ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="discount-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" id="discount-date">
                </div>
                <div class="form-group">
                    <label for="discount-product">–ù–∞ –∫–∞–∫–æ–π —Ç–æ–≤–∞—Ä</label>
                    <input type="text" id="discount-product" placeholder="–í—Å–µ —Ç–æ–≤–∞—Ä—ã / –í–µ—Ä—Ö–Ω—è—è –æ–¥–µ–∂–¥–∞ / –∏ —Ç.–¥.">
                </div>
                <div style="display: flex; gap: var(--spacing-md);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="hideAddDiscountModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –°–ö–†–ò–ü–¢–´ -->
    <script src="js/pwa.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/admin.js"></script>

    <script>
        // ============================================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–ò
        // ============================================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Admin: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!window.Auth?.requireAuth?.()) {
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateUserInfo();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventHandlers();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–≤–∏–ª—å–æ–Ω–æ–≤
            loadPavilions();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStats();
        });

        // ============================================================
        // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================================

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —à–∞–ø–∫–µ
         */
        function updateUserInfo() {
            const tenant = window.Auth?.getCurrentTenant?.();
            if (tenant) {
                document.getElementById('user-name').textContent = `üë§ ${tenant.name}`;
            }
        }

        /**
         * –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ñ–æ—Ä–º—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
         */
        function setupEventHandlers() {
            // –§–æ—Ä–º–∞ –ø–∞–≤–∏–ª—å–æ–Ω–∞
            document.getElementById('pavilion-form').addEventListener('submit', handleSavePavilion);

            // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    document.getElementById('category-input').value = chip.dataset.category;
                });
            });

            // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    document.getElementById('brand-color-input').value = option.dataset.color;
                });
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            document.getElementById('image-input').addEventListener('change', handleImageUpload);

            // –§–æ—Ä–º–∞ —Å–∫–∏–¥–∫–∏
            document.getElementById('discount-form').addEventListener('submit', handleAddDiscount);
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
         */
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä (–º–∞–∫—Å 2 –ú–ë)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 2 –ú–ë');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            const reader = new FileReader();
            reader.onload = (event) => {
                const preview = document.getElementById('image-preview');
                preview.src = event.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞–≤–∏–ª—å–æ–Ω–∞
         */
        async function handleSavePavilion(e) {
            e.preventDefault();

            try {
                const data = {
                    floor: document.getElementById('floor-input').value,
                    location: document.getElementById('location-input').value,
                    name: document.getElementById('name-input').value,
                    category: document.getElementById('category-input').value,
                    brand_color: document.getElementById('brand-color-input').value
                };

                if (!data.category) {
                    alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                    return;
                }

                console.log('üíæ Admin: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞–≤–∏–ª—å–æ–Ω–∞', data);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î —á–µ—Ä–µ–∑ Data API
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Data.createPavilion() –∏–ª–∏ Data.updatePavilion()
                alert('‚úÖ –ü–∞–≤–∏–ª—å–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                loadPavilions();
                updateStats();

            } catch (error) {
                console.error('‚ùå Admin: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞–≤–∏–ª—å–æ–Ω–∞');
            }
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
         */
        function showAddDiscountModal() {
            document.getElementById('discount-modal').style.display = 'flex';
        }

        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
         */
        function hideAddDiscountModal() {
            document.getElementById('discount-modal').style.display = 'none';
            document.getElementById('discount-form').reset();
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
         */
        function handleAddDiscount(e) {
            e.preventDefault();

            const discountData = {
                title: document.getElementById('discount-title').value,
                description: document.getElementById('discount-desc').value,
                endDate: document.getElementById('discount-date').value,
                product: document.getElementById('discount-product').value
            };

            console.log('‚ûï Admin: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏', discountData);
            alert('‚úÖ –°–∫–∏–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');

            hideAddDiscountModal();
        }

        /**
         * –í—ã–±–∏—Ä–∞–µ—Ç —ç—Ç–∞–∂ –Ω–∞ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ
         */
        function selectFloor(floor) {
            // –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
            document.querySelector(`[data-floor="${floor}"]`).classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä —ç—Ç–∞–∂–∞ –≤ —Ñ–æ—Ä–º–µ
            document.getElementById('floor-input').value = floor;
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
         */
        function handleLogout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                window.Auth?.logout?.();
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–∞–≤–∏–ª—å–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
         */
        async function loadPavilions() {
            try {
                const tenant = window.Auth?.getCurrentTenant?.();
                if (!tenant) return;

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–∞–≤–∏–ª—å–æ–Ω—ã –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ tenant_id
                const pavilions = await window.Data?.getAllPavilions?.();
                const myPavilions = pavilions?.filter(p => p.tenant_id === tenant.id) || [];

                const tbody = document.getElementById('pavilions-list');
                
                if (myPavilions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-light);">
                                –ù–µ—Ç –ø–∞–≤–∏–ª—å–æ–Ω–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø–∞–≤–∏–ª—å–æ–Ω –≤—ã—à–µ.
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = myPavilions.map(p => `
                    <tr>
                        <td>${p.floor || '-'}</td>
                        <td>${p.location || '-'}</td>
                        <td>${p.name || '-'}</td>
                        <td>${p.category || '-'}</td>
                        <td>${(p.discounts?.length || 0)} —Å–∫–∏–¥–æ–∫</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-small btn-primary" onclick="editPavilion('${p.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button class="btn btn-small btn-danger" onclick="deletePavilion('${p.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('‚ùå Admin: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–≤–∏–ª—å–æ–Ω–æ–≤', error);
            }
        }

        /**
         * –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –ø–∞–≤–∏–ª—å–æ–Ω
         */
        function editPavilion(pavilionId) {
            console.log('‚úèÔ∏è Admin: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–≤–∏–ª—å–æ–Ω–∞', pavilionId);
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
        }

        /**
         * –£–¥–∞–ª—è–µ—Ç –ø–∞–≤–∏–ª—å–æ–Ω
         */
        async function deletePavilion(pavilionId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–∞–≤–∏–ª—å–æ–Ω?')) {
                return;
            }

            try {
                await window.Data?.deletePavilion?.(pavilionId);
                alert('‚úÖ –ü–∞–≤–∏–ª—å–æ–Ω —É–¥–∞–ª—ë–Ω');
                loadPavilions();
                updateStats();
            } catch (error) {
                console.error('‚ùå Admin: –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞–≤–∏–ª—å–æ–Ω–∞');
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
         */
        async function updateStats() {
            try {
                const tenant = window.Auth?.getCurrentTenant?.();
                if (!tenant) return;

                const pavilions = await window.Data?.getAllPavilions?.();
                const myPavilions = pavilions?.filter(p => p.tenant_id === tenant.id) || [];

                const totalDiscounts = myPavilions.reduce((sum, p) => sum + (p.discounts?.length || 0), 0);

                document.getElementById('stat-pavilions').textContent = myPavilions.length;
                document.getElementById('stat-discounts').textContent = totalDiscounts;
                document.getElementById('stat-views').textContent = '0'; // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—á—ë—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤

            } catch (error) {
                console.error('‚ùå Admin: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', error);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('discount-modal');
            if (e.target === modal) {
                hideAddDiscountModal();
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Admin API, –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Admin && typeof window.Admin.init === 'function') {
                try { window.Admin.init(); } catch (e) { console.error('Admin.init() error', e); }
            }
        });
    </script>
</body>
</html>
