<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Админ-панель Апрашки — Управление корпусами, этажами и павильонами">
    <meta name="theme-color" content="#000000">
    <title>Админ-панель — Карта Апрашки</title>
    
    <!-- Supabase Configuration (передается через meta теги для безопасности) -->
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFhZ3B1dWNkbmtyendzbW5ieW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDMxMjYsImV4cCI6MjA4NjA3OTEyNn0.T3vEY9VfxIQ19AtWPkwk6xiqAZe6sEzG-Ke73olUPsY">
    <meta name="supabase-url" content="https://qagpuucdnkrzwsmnbymk.supabase.co">
    
    <!-- Инициализация конфигурации Supabase из <meta> тегов -->
    <script>
            window.SupabaseConfig = {
                url: document.querySelector('meta[name="supabase-url"]').content.trim(),
                anonKey: document.querySelector('meta[name="supabase-anon-key"]').content.trim()
            };
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- Стили -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- ШАПКА АДМИН-ПАНЕЛИ -->
    <header class="admin-header">
        <div class="admin-header-title">
            <h1>Админ-панель</h1>
        </div>
        <div class="admin-header-user" id="user-info">
            <span id="user-name">Загрузка...</span>
            <button class="btn btn-primary" onclick="handleLogout()">Выход</button>
        </div>
    </header>

    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <main class="app-main">
        <!-- СТАТИСТИКА -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="stat-pavilions">0</div>
                <div class="stat-label">Павильонов в корпусах</div>
            </div>
            <div class="stat-card" onclick="window.location.href='./discounts.html'" style="cursor: pointer;">
                <div class="stat-number" id="stat-discounts">0</div>
                <div class="stat-label">Скидок</div>
            </div>
        </section>

        <!-- ОСНОВНАЯ РАЗМЕТКА: ДВЕ КОЛОНКИ -->
        <div class="admin-container">
            <!-- ЛЕВАЯ КОЛОНКА: ФОРМА РЕДАКТИРОВАНИЯ -->
            <div class="edit-panel">
                <h2 class="admin-section-title">Корпус → Этаж → Павильон</h2>

                <form id="pavilion-form">
                    <!-- КОРПУС -->
                    <div class="form-group">
                        <label for="building-select">Корпус</label>
                        <select id="building-select" required>
                            <option value="">Выберите корпус</option>
                            <option value="A">Корпус A</option>
                            <option value="B">Корпус B</option>
                            <option value="C">Корпус C</option>
                            <option value="D">Корпус D</option>
                            <option value="33">Корпус 33</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="showAddBuildingModal()" style="margin-top: var(--spacing-sm);">Добавить свой корпус</button>
                    </div>

                    <!-- ЭТАЖ -->
                    <div class="form-group">
                        <label for="floor-input">Этаж</label>
                        <select id="floor-input" required>
                            <option value="">Выберите этаж</option>
                            <option value="1">1 этаж</option>
                            <option value="2">2 этаж</option>
                            <option value="3">3 этаж</option>
                            <option value="4">4 этаж</option>
                            <option value="5">5 этаж</option>
                        </select>
                    </div>

                    <!-- ПЛАН ЭТАЖА КОРПУСА 33 -->
                    <div class="form-group" id="floor-plan-container" style="display: none;">
                        <label>План этажа (кликните для указания позиции)</label>
                        <div style="border: 2px solid var(--color-border); border-radius: var(--radius-md); overflow: hidden; max-width: 100%; background: #f0f0f0; position: relative;">
                            <img id="floor-plan-image" src="/images/floor-plans/building_33_floor_1.png" alt="План этажа" style="width: 100%; height: auto; display: block; cursor: crosshair;">
                            <canvas id="floor-plan-canvas" style="position: absolute; top: 0; left: 0; cursor: crosshair; display: none;"></canvas>
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-light); margin-top: var(--spacing-xs);" id="coords-display"></div>
                        <input type="hidden" id="pavilion-x" value="">
                        <input type="hidden" id="pavilion-y" value="">
                    </div>

                    <!-- НОМЕР ПАВИЛЬОНА -->
                    <div class="form-group">
                        <label for="location-input">Номер павильона (в выбранном корпусе на этаже) *</label>
                        <input type="text" id="location-input" placeholder="Например: 123, A-45" required>
                    </div>

                    <!-- НАЗВАНИЕ МАГАЗИНА -->
                    <div class="form-group">
                        <label for="name-input">Название магазина *</label>
                        <input type="text" id="name-input" placeholder="Название вашего магазина" required>
                    </div>

                    <!-- КАТЕГОРИЯ -->
                    <div class="form-group">
                        <label for="category-select">Категория *</label>
                        <select id="category-select" class="form-select" required>
                            <option value="">Выберите категорию</option>
                            <option value="clothing">Одежда</option>
                            <option value="shoes">Обувь</option>
                            <option value="accessories">Аксессуары</option>
                            <option value="electronics">Электроника</option>
                            <option value="cosmetics">Косметика</option>
                            <option value="sports">Спорт</option>
                            <option value="other">Прочее</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="showAddCategoryModal()" style="margin-top: var(--spacing-sm);">Добавить свою категорию</button>
                        <input type="hidden" id="category-input" required>
                    </div>

                    <!-- ЗАГРУЗКА ИЗОБРАЖЕНИЯ -->
                    <div class="form-group">
                        <label for="image-input">Изображение (макс. 2 МБ)</label>
                        <div class="image-upload-area" onclick="document.getElementById('image-input').click()">
                            <p>Кликните или перетащите изображение</p>
                        </div>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <img id="image-preview" class="image-preview" style="display: none;">
                    </div>

                    <!-- ЦВЕТ БРЕНДИРОВАНИЯ -->
                    <div class="form-group">
                        <label>Цвет брендирования</label>
                        <div class="color-palette" id="color-palette">
                            <div class="color-option" style="background: #E91E63" data-color="#E91E63" title="Розовый"></div>
                            <div class="color-option" style="background: #9C27B0" data-color="#9C27B0" title="Фиолетовый"></div>
                            <div class="color-option" style="background: #2196F3" data-color="#2196F3" title="Синий"></div>
                            <div class="color-option" style="background: #00BCD4" data-color="#00BCD4" title="Голубой"></div>
                            <div class="color-option" style="background: #4CAF50" data-color="#4CAF50" title="Зелёный"></div>
                            <div class="color-option" style="background: #8BC34A" data-color="#8BC34A" title="Светло-зеленый"></div>
                            <div class="color-option" style="background: #FFC107" data-color="#FFC107" title="Жёлтый"></div>
                            <div class="color-option" style="background: #FF9800" data-color="#FF9800" title="Оранжевый"></div>
                            <div class="color-option" style="background: #FF5722" data-color="#FF5722" title="Красно-оранжевый"></div>
                            <div class="color-option" style="background: #F44336" data-color="#F44336" title="Красный"></div>
                            <div class="color-option" style="background: #795548" data-color="#795548" title="Коричневый"></div>
                            <div class="color-option" style="background: #9E9E9E" data-color="#9E9E9E" title="Серый"></div>
                        </div>
                        <input type="hidden" id="brand-color-input" value="#FF6B35">
                    </div>

                    <!-- КНОПКИ -->
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Сохранить</button>
                        <button type="reset" class="btn btn-secondary" style="flex: 1;">Отмена</button>
                    </div>
                </form>
            </div>

            <!-- ПРАВАЯ КОЛОНКА: ПРЕДПРОМОТР КАРТЫ -->
            <div class="preview-panel">
                <h2 class="admin-section-title">Карта</h2>

                <!-- ВЫБОР ЭТАЖА -->
                <div class="map-section">
                    <h3>Выберите этаж:</h3>
                    <div class="floor-selector" id="floor-selector">
                        <button class="floor-btn active" data-floor="1" onclick="selectFloor(1)">1 этаж</button>
                        <button class="floor-btn" data-floor="2" onclick="selectFloor(2)">2 этаж</button>
                        <button class="floor-btn" data-floor="3" onclick="selectFloor(3)">3 этаж</button>
                        <button class="floor-btn" data-floor="4" onclick="selectFloor(4)">4 этаж</button>
                        <button class="floor-btn" data-floor="5" onclick="selectFloor(5)">5 этаж</button>
                    </div>
                </div>

                <!-- КАРТА МИНИАТЮРА -->
                <div class="map-section">
                    <div class="map-container-mini" id="map-mini">
                        <div class="map-hint">
                            <p>Нажмите на карте, чтобы установить локацию павильона в корпусе</p>
                        </div>
                        <div id="mini-map" style="width:100%; height:300px;"></div>
                    </div>
                </div>

                <!-- ИНФОРМАЦИЯ -->
                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-bg-light); border-radius: var(--radius-md);">
                    <p style="font-size: var(--font-size-sm); margin: 0;">
                        <strong>Совет:</strong> Выберите корпус, этаж и кликните на карте справа, чтобы установить координаты вашего павильона.
                    </p>
                </div>
            </div>
        </div>

        <!-- СПИСОК ПАВИЛЬОНОВ (ПО КОРПУСАМ И ЭТАЖАМ) -->
        <section class="pavilions-list-section">
            <h2 class="admin-section-title">Мои павильоны (по корпусам)</h2>
            
            <div style="overflow-x: auto;">
                <table class="pavilions-table" id="pavilions-table">
                    <thead>
                        <tr>
                            <th>Корпус</th>
                            <th>Этаж</th>
                            <th>Номер</th>
                            <th>Название</th>
                            <th>Категория</th>
                            <th>Скидки</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="pavilions-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-light);">
                                Загрузка павильонов из всех корпусов...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- МОДАЛЬНОЕ ОКНО: ДОБАВИТЬ КОРПУС -->
    <div id="add-building-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Добавить корпус</h3>
                <button class="modal-close" onclick="hideAddBuildingModal()">Закрыть</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-building-input">Название корпуса *</label>
                    <input type="text" id="new-building-input" class="form-input" placeholder="Например: E, Новый" maxlength="10" style="width: 100%; padding: var(--spacing-sm);">
                    <div id="building-error" style="margin-top: var(--spacing-xs); color: #c00; font-size: var(--font-size-sm); display: none;"></div>
                    <div style="margin-top: var(--spacing-xs); font-size: var(--font-size-xs); color: var(--color-text-light);">
                        Длина: 1-10 символов.
                    </div>
                </div>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                    <button type="button" class="btn btn-primary" onclick="saveNewBuilding()" style="flex: 1;">Добавить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddBuildingModal()" style="flex: 1;">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО: ДОБАВИТЬ КАТЕГОРИЮ -->
    <div id="add-category-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Добавить категорию</h3>
                <button class="modal-close" onclick="hideAddCategoryModal()">Закрыть</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-category-input">Название категории *</label>
                    <input type="text" id="new-category-input" class="form-input" placeholder="Например: Украшения" maxlength="20" style="width: 100%; padding: var(--spacing-sm);">
                    <div id="category-suggestions" style="margin-top: var(--spacing-xs); font-size: var(--font-size-sm); color: var(--color-text-light);"></div>
                    <div id="category-error" style="margin-top: var(--spacing-xs); color: #c00; font-size: var(--font-size-sm); display: none;"></div>
                    <div style="margin-top: var(--spacing-xs); font-size: var(--font-size-xs); color: var(--color-text-light);">
                        Только буквы, пробелы и дефисы. Длина: 2-20 символов.
                    </div>
                </div>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                    <button type="button" class="btn btn-primary" onclick="saveNewCategory()" style="flex: 1;">Добавить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddCategoryModal()" style="flex: 1;">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО: ДОБАВИТЬ СКИДКУ -->
    <div id="discount-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить скидку</h3>
                <button class="modal-close" onclick="hideAddDiscountModal()">Закрыть</button>
            </div>
            <form id="discount-form">
                <div class="form-group">
                    <label for="discount-title">Название скидки *</label>
                    <input type="text" id="discount-title" placeholder="24-часовая распродажа" required>
                </div>
                <div class="form-group">
                    <label for="discount-desc">Описание *</label>
                    <textarea id="discount-desc" placeholder="20% на все товары" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="discount-date">Дата окончания</label>
                    <input type="date" id="discount-date">
                </div>
                <div class="form-group">
                    <label for="discount-product">На какой товар</label>
                    <input type="text" id="discount-product" placeholder="Все товары / Верхняя одежда / и т.д.">
                </div>
                <div style="display: flex; gap: var(--spacing-md);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Добавить</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="hideAddDiscountModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- СКРИПТЫ -->
    <script src="js/pwa.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/admin.js"></script>

    <script>
        // ============================================================
        // ИНИЦИАЛИЗАЦИЯ АДМИН-ПАНЕЛИ
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Admin: Инициализация админ-панели');
            
            // Используем API из admin.js
            if (window.Admin && typeof window.Admin.init === 'function') {
                try {
                    window.Admin.init();
                } catch (error) {
                    console.error('❌ Admin: Ошибка инициализации', error);
                }
            } else {
                console.warn('Admin: window.Admin.init не найден');
            }
        });

        // ============================================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ UI
        // ============================================================

        // Управление корпусами
        const existingBuildings = ['A', 'B', 'C', 'D'];

        function showAddBuildingModal() {
            document.getElementById('add-building-modal').style.display = 'flex';
            document.getElementById('new-building-input').value = '';
            document.getElementById('building-error').style.display = 'none';
            document.getElementById('new-building-input').focus();
        }

        function hideAddBuildingModal() {
            document.getElementById('add-building-modal').style.display = 'none';
        }

        function validateBuilding(input) {
            const cleaned = input.trim();
            
            if (cleaned.length < 1 || cleaned.length > 10) {
                return { valid: false, error: 'Длина должна быть от 1 до 10 символов' };
            }
            
            if (existingBuildings.includes(cleaned.toUpperCase())) {
                return { valid: false, error: 'Такой корпус уже существует' };
            }
            
            return { valid: true, cleaned: cleaned };
        }

        function saveNewBuilding() {
            const input = document.getElementById('new-building-input').value;
            const errorDiv = document.getElementById('building-error');
            
            const validation = validateBuilding(input);
            
            if (!validation.valid) {
                errorDiv.textContent = validation.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            const buildingSelect = document.getElementById('building-select');
            const newOption = document.createElement('option');
            const buildingValue = validation.cleaned.toUpperCase();
            newOption.value = buildingValue;
            newOption.textContent = 'Корпус ' + buildingValue;
            
            buildingSelect.appendChild(newOption);
            buildingSelect.value = buildingValue;
            existingBuildings.push(buildingValue);
            
            alert('Корпус "' + buildingValue + '" успешно добавлен!');
            hideAddBuildingModal();
        }

        // Управление категориями
        const existingCategories = [
            'одежда', 'обувь', 'аксессуары', 'электроника', 'косметика', 'спорт', 'прочее'
        ];

        function showAddCategoryModal() {
            document.getElementById('add-category-modal').style.display = 'flex';
            document.getElementById('new-category-input').value = '';
            document.getElementById('category-error').style.display = 'none';
            document.getElementById('category-suggestions').textContent = '';
            document.getElementById('new-category-input').focus();
        }

        function hideAddCategoryModal() {
            document.getElementById('add-category-modal').style.display = 'none';
        }

        function validateCategory(input) {
            // Удаляем лишние пробелы и приводим к нижнему регистру
            const cleaned = input.trim().toLowerCase().replace(/\s+/g, ' ');
            
            // Проверка длины
            if (cleaned.length < 2 || cleaned.length > 20) {
                return { valid: false, error: 'Длина должна быть от 2 до 20 символов' };
            }
            
            // Проверка на специальные символы (только буквы, пробелы, дефисы)
            if (!/^[а-яёa-z\s-]+$/i.test(cleaned)) {
                return { valid: false, error: 'Используйте только буквы, пробелы и дефисы' };
            }
            
            // Проверка на дубликаты
            if (existingCategories.includes(cleaned)) {
                return { valid: false, error: 'Такая категория уже существует' };
            }
            
            return { valid: true, cleaned: cleaned };
        }

        function getSimilarCategories(input) {
            if (!input || input.length < 2) return [];
            
            const normalized = input.toLowerCase();
            return existingCategories.filter(cat => 
                cat.includes(normalized) || normalized.includes(cat)
            );
        }

        // Автодополнение при вводе
        document.addEventListener('DOMContentLoaded', () => {
            const categoryInput = document.getElementById('new-category-input');
            if (categoryInput) {
                categoryInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    const suggestionsDiv = document.getElementById('category-suggestions');
                    const errorDiv = document.getElementById('category-error');
                    
                    if (value.length >= 2) {
                        const similar = getSimilarCategories(value);
                        if (similar.length > 0) {
                            suggestionsDiv.textContent = 'Похожие категории: ' + similar.join(', ');
                            suggestionsDiv.style.color = '#ff6b35';
                        } else {
                            suggestionsDiv.textContent = '';
                        }
                        
                        // Проверка валидности в реальном времени
                        const validation = validateCategory(value);
                        if (!validation.valid) {
                            errorDiv.textContent = validation.error;
                            errorDiv.style.display = 'block';
                        } else {
                            errorDiv.style.display = 'none';
                        }
                    } else {
                        suggestionsDiv.textContent = '';
                        errorDiv.style.display = 'none';
                    }
                });
            }
            
            // Обновляем скрытое поле при выборе категории
            const categorySelect = document.getElementById('category-select');
            if (categorySelect) {
                categorySelect.addEventListener('change', (e) => {
                    document.getElementById('category-input').value = e.target.value;
                });
            }
            
            // Обработка выбора корпуса 33 и отображение плана этажа
            const buildingSelect = document.getElementById('building-select');
            const floorPlanContainer = document.getElementById('floor-plan-container');
            if (buildingSelect) {
                buildingSelect.addEventListener('change', (e) => {
                    if (e.target.value === '33') {
                        floorPlanContainer.style.display = 'block';
                        setupFloorPlanClick();
                    } else {
                        floorPlanContainer.style.display = 'none';
                    }
                });
            }
        });

        function setupFloorPlanClick() {
            const floorPlanImage = document.getElementById('floor-plan-image');
            const coordsDisplay = document.getElementById('coords-display');
            const xInput = document.getElementById('pavilion-x');
            const yInput = document.getElementById('pavilion-y');
            
            if (floorPlanImage) {
                floorPlanImage.addEventListener('click', (e) => {
                    const rect = floorPlanImage.getBoundingClientRect();
                    const x = Math.round(e.clientX - rect.left);
                    const y = Math.round(e.clientY - rect.top);
                    
                    xInput.value = x;
                    yInput.value = y;
                    coordsDisplay.textContent = `Позиция: X=${x}, Y=${y}`;
                    
                    // Отправляем координаты в скрытые поля для сохранения
                    console.log('Павильон позиция установлена: x=' + x + ', y=' + y);
                });
            }
        }

        function hideAddCategoryModal() {
            document.getElementById('add-category-modal').style.display = 'none';
        }

        function saveNewCategory() {
            const input = document.getElementById('new-category-input').value;
            const errorDiv = document.getElementById('category-error');
            
            const validation = validateCategory(input);
            
            if (!validation.valid) {
                errorDiv.textContent = validation.error;
                errorDiv.style.display = 'block';
                return;
            }
            
            // Добавляем категорию в список
            const categorySelect = document.getElementById('category-select');
            const newOption = document.createElement('option');
            const categoryValue = validation.cleaned.replace(/\s+/g, '-');
            newOption.value = categoryValue;
            newOption.textContent = validation.cleaned.charAt(0).toUpperCase() + validation.cleaned.slice(1);
            
            // Вставляем перед последней опцией (которая может быть "Прочее")
            categorySelect.appendChild(newOption);
            
            // Выбираем новую категорию
            categorySelect.value = categoryValue;
            document.getElementById('category-input').value = categoryValue;
            
            // Добавляем в список существующих
            existingCategories.push(validation.cleaned);
            
            // Показываем уведомление
            alert('Категория "' + newOption.textContent + '" успешно добавлена!');
            
            hideAddCategoryModal();
        }

        function showAddDiscountModal() {
            document.getElementById('discount-modal').style.display = 'flex';
        }

        function hideAddDiscountModal() {
            document.getElementById('discount-modal').style.display = 'none';
            if (document.getElementById('discount-form')) {
                document.getElementById('discount-form').reset();
            }
        }

        function handleLogout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                if (window.Auth && typeof window.Auth.logout === 'function') {
                    window.Auth.logout();
                }
            }
        }

        function selectFloor(floor) {
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-floor="${floor}"]`).classList.add('active');
            
            if (window.Admin && typeof window.Admin.selectFloor === 'function') {
                window.Admin.selectFloor(floor);
            }
        }

        // Закрытие модального окна при клике на фон
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('discount-modal');
            if (e.target === modal) {
                hideAddDiscountModal();
            }
        });
    </script>
</body>
</html>
